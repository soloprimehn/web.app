<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Animador de Imágenes Pro+</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --font-family-main: 'Outfit', sans-serif;
      --bg-color: #f0f2f5;
      --text-color-hero-header: #111827;
      --text-color-body: #6b7280;
      --text-color-muted: #9ca3af;
      --primary-color: #111827;
      --primary-hover-color: #374151;
      --secondary-color: #4f46e5;
      --secondary-hover-color: #4338ca;
      --tertiary-color: #d1d5db;
      --tertiary-hover-color: #9ca3af;
      --card-bg-color: #ffffff;
      --border-color: #e5e7eb;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --border-radius: 0.75rem;
      --container-max-width: 1200px;
      --spacing-unit: 1rem;
      --transition-speed: 0.3s;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family-main);
      background-color: var(--bg-color);
      color: var(--text-color-body);
      font-size: 18px;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 5rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header.sticky-header {
      position: fixed; top: 0; left: 0; width: 100%;
      background: rgba(255 255 255 / 0.9);
      backdrop-filter: saturate(180%) blur(12px);
      box-shadow: 0 1px 4px var(--shadow-light);
      z-index: 10000;
      padding: calc(var(--spacing-unit) * 0.75) 0;
      display: flex; justify-content: center;
    }
    header .header-content {
      max-width: var(--container-max-width); width: 100%;
      padding: 0 var(--spacing-unit);
      display: flex; justify-content: space-between; align-items: center;
    }
    header .logo {
      font-weight: 800; font-size: 1.5rem; color: var(--primary-color);
      letter-spacing: -0.05em; user-select: none;
    }
    header nav {
      display: flex; gap: var(--spacing-unit); font-weight: 600;
      font-size: 1rem; color: var(--text-color-muted);
    }
    header nav a {
      text-decoration: none; color: var(--text-color-muted);
      transition: color var(--transition-speed) ease;
    }
    header nav a:hover, header nav a:focus-visible { color: var(--primary-color); outline: none; }

    main.main-container {
      max-width: var(--container-max-width); width: 100%;
      margin: 0 auto;
      padding: calc(var(--spacing-unit) * 4) var(--spacing-unit) calc(var(--spacing-unit) * 6);
      flex-grow: 1; display: flex; flex-direction: column;
      gap: calc(var(--spacing-unit) * 6);
    }

    section.hero-section {
      text-align: center; padding-bottom: calc(var(--spacing-unit) * 2);
    }
    section.hero-section h1 {
      font-weight: 800; font-size: clamp(3rem, 6vw, 4.5rem);
      color: var(--text-color-hero-header); margin-bottom: var(--spacing-unit);
      letter-spacing: -0.02em; line-height: 1.1; user-select: none;
    }
    section.hero-section p.subtitle {
      font-weight: 400; font-size: 1.25rem; color: var(--text-color-muted);
      max-width: 640px; margin-left: auto; margin-right: auto;
      margin-bottom: calc(var(--spacing-unit) * 2.5);
    }

    label.upload-button-styled {
      display: inline-flex; align-items: center; background-color: var(--primary-color);
      color: #fff; font-weight: 700; font-size: 1.125rem; padding: 1rem 2rem;
      border-radius: var(--border-radius); cursor: pointer;
      box-shadow: 0 4px 14px rgba(17, 24, 39, 0.3);
      transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
      user-select: none; border: none;
    }
    label.upload-button-styled:hover, label.upload-button-styled:focus-visible {
      background-color: var(--primary-hover-color);
      box-shadow: 0 6px 20px rgba(17, 24, 39, 0.45);
      outline: none;
    }
    input#imageUpload { display: none; }

    .content-layout {
      display: grid; grid-template-columns: 1fr;
      gap: calc(var(--spacing-unit) * 4);
    }
    @media (min-width: 768px) {
      .content-layout { grid-template-columns: 2fr 1fr; align-items: start; }
    }

    section.image-preview-area, section.controls-area {
      background-color: var(--card-bg-color); border-radius: var(--border-radius);
      box-shadow: 0 16px 32px var(--shadow-light);
      padding: calc(var(--spacing-unit) * 3);
      position: relative;
    }
    section.image-preview-area h2, section.controls-area h2 {
      font-weight: 700; font-size: 1.75rem; color: var(--text-color-hero-header);
      border-bottom: solid 2px var(--border-color);
      padding-bottom: 0.5rem; margin-bottom: 2rem; user-select: none;
    }
    #animatedOutputContainer {
      width: 100%; height: 520px;
      border-radius: calc(var(--border-radius) / 2);
      border: 2px dashed var(--border-color); background-color: #fff;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden; position: relative; user-select: none;
    }
    #animatedOutputContainer img {
      max-width: 100%; max-height: 100%;
      object-fit: contain; border-radius: calc(var(--border-radius) / 2);
      display: block; animation-fill-mode: both;
      animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .placeholder-text {
      color: var(--text-color-muted); font-style: italic;
      font-size: 1.125rem; user-select: none;
    }

    .drag-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(79, 70, 229, 0.2);
      border: 4px dashed var(--secondary-color);
      border-radius: var(--border-radius);
      display: flex; justify-content: center; align-items: center;
      color: var(--secondary-color); font-weight: 700; font-size: 1.5rem;
      pointer-events: none; opacity: 0; transition: opacity var(--transition-speed) ease;
    }
    .drag-overlay.visible { opacity: 1; }

    .control-group { margin-bottom: calc(var(--spacing-unit) * 2); }
    .control-group label {
      display: block; font-weight: 600; color: var(--text-color-muted);
      margin-bottom: 0.5rem; user-select: none; font-size: 1rem;
    }
    .control-group select, .control-group input[type='number'] {
      width: 100%; padding: 0.75rem 1rem; font-size: 1rem;
      border-radius: var(--border-radius); border: 1.5px solid var(--border-color);
      transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
      background-color: #fff; color: var(--text-color-hero-header);
      font-weight: 600; outline: none;
    }
    .control-group select:hover,
    .control-group input[type='number']:hover {
      border-color: var(--primary-color);
    }
    .control-group select:focus-visible,
    .control-group input[type='number']:focus-visible {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1);
    }
    
    .button-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }
    .button-container.full-width {
      grid-template-columns: 1fr;
    }

    button.action-button {
      padding: 1rem 0; font-size: 1.125rem;
      font-weight: 700; font-family: var(--font-family-main);
      background-color: var(--primary-color); color: #fff;
      border-radius: var(--border-radius); border: none; cursor: pointer;
      box-shadow: 0 8px 24px rgba(17, 24, 39, 0.3);
      transition: all var(--transition-speed) ease;
      user-select: none; display: inline-flex; justify-content: center; align-items: center;
      gap: 0.5rem;
    }
    button.action-button.secondary { background-color: var(--secondary-color); }
    button.action-button.tertiary {
      background-color: transparent;
      color: var(--text-color-body);
      border: 2px solid var(--tertiary-color);
      box-shadow: none;
    }

    button.action-button:hover:not(:disabled), button.action-button:focus-visible:not(:disabled) {
      box-shadow: 0 10px 30px rgba(17, 24, 39, 0.4);
      outline: none; transform: translateY(-2px);
    }
    button.action-button.primary:hover:not(:disabled), button.action-button.primary:focus-visible:not(:disabled) { background-color: var(--primary-hover-color); }
    button.action-button.secondary:hover:not(:disabled), button.action-button.secondary:focus-visible:not(:disabled) { background-color: var(--secondary-hover-color); }
    button.action-button.tertiary:hover:not(:disabled), button.action-button.tertiary:focus-visible:not(:disabled) {
      background-color: var(--tertiary-color);
      border-color: var(--tertiary-color);
      color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: none;
    }
    button.action-button:disabled {
      background-color: var(--text-color-muted); cursor: not-allowed;
      box-shadow: none; transform: none; color: #d1d5db;
      opacity: 0.7;
    }
    .recording-dot {
      width: 10px; height: 10px; background-color: red;
      border-radius: 50%; animation: blink 1s infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fadeIn { animation-name: fadeIn; }
    @keyframes slideInLeft { from { transform: translateX(-50%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .animate-slideInLeft { animation-name: slideInLeft; }
    @keyframes slideInRight { from { transform: translateX(50%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .animate-slideInRight { animation-name: slideInRight; }
    @keyframes slideInUp { from { transform: translateY(50%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-slideInUp { animation-name: slideInUp; }
    @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .animate-zoomIn { animation-name: zoomIn; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .animate-pulse { animation-name: pulse; }
    @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-20px); } 60% { transform: translateY(-10px); } }
    .animate-bounce { animation-name: bounce; }
    @keyframes tada { from { transform: scale3d(1, 1, 1); } 10%, 20% { transform: scale3d(0.9, 0.9, 0.9) rotate3d(0, 0, 1, -3deg); } 30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); } 40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); } to { transform: scale3d(1, 1, 1); } }
    .animate-tada { animation-name: tada; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .animate-shake { animation-name: shake; }

    footer.app-footer {
      text-align: center; padding: calc(var(--spacing-unit) * 3) var(--spacing-unit);
      color: var(--text-color-muted); font-size: 0.9rem;
      border-top: 1px solid var(--border-color); user-select: none;
    }

    #toast-notification {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translate(-50%, 200%);
      background-color: var(--primary-color);
      color: white;
      padding: 1rem 2rem;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(17, 24, 39, 0.5);
      z-index: 20000;
      transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
      font-weight: 600;
    }
    #toast-notification.show {
      transform: translate(-50%, 0);
    }
  </style>
</head>
<body>
  <header class="sticky-header" role="banner">
    <div class="header-content">
      <div class="logo">Animador Pro+</div>
      <nav aria-label="Navegación principal"><a href="#">Inicio</a></nav>
    </div>
  </header>

  <main class="main-container" role="main">
    <section class="hero-section">
      <h1>Anima Tus Imágenes al Instante</h1>
      <p class="subtitle">Sube una imagen, ajusta el efecto en tiempo real y exporta tu creación. ¡Fácil, rápido y directamente en tu navegador!</p>
      <label for="imageUpload" class="upload-button-styled" tabindex="0">Seleccionar Imagen</label>
      <input type="file" id="imageUpload" accept="image/*" />
    </section>

    <div class="content-layout">
      <article class="image-preview-area" id="drop-zone" aria-labelledby="preview-title">
        <div class="drag-overlay"><p>¡Suelta la imagen aquí!</p></div>
        <h2 id="preview-title">Vista Previa y Animación</h2>
        <div id="animatedOutputContainer">
          <p class="placeholder-text">Sube una imagen o arrástrala aquí</p>
          <img id="imagePreview" src="#" alt="Vista previa de imagen animada" style="display:none" />
        </div>
      </article>

      <aside class="controls-area" aria-labelledby="controls-title">
        <h2 id="controls-title">Controles de Animación</h2>
        <div class="control-group">
          <label for="animationType">Tipo de Animación:</label>
          <select id="animationType">
            <option value="">Ninguna</option>
            <option value="fadeIn">Fundido (Fade In)</option>
            <option value="slideInLeft">Deslizar Izquierda</option>
            <option value="slideInRight">Deslizar Derecha</option>
            <option value="slideInUp">Deslizar Arriba</option>
            <option value="zoomIn">Acercar (Zoom In)</option>
            <option value="pulse">Pulsar</option>
            <option value="bounce">Rebotar</option>
            <option value="tada">Tada!</option>
            <option value="shake">Agitar (Shake)</option>
          </select>
        </div>
        <div class="control-group">
            <label for="animationDirection">Dirección:</label>
            <select id="animationDirection">
                <option value="normal">Normal</option>
                <option value="reverse">Inversa</option>
                <option value="alternate">Alterna (va y viene)</option>
                <option value="alternate-reverse">Alterna Inversa</option>
            </select>
        </div>
        <div class="control-group">
          <label for="animationDuration">Duración (segundos):</label>
          <input type="number" id="animationDuration" value="1" min="0.1" step="0.1" />
        </div>
        <div class="control-group">
          <label for="animationIteration">Repeticiones (0 para infinito):</label>
          <input type="number" id="animationIteration" value="1" min="0" step="1" />
        </div>
        <div class="control-group">
          <label for="animationDelay">Retraso (segundos):</label>
          <input type="number" id="animationDelay" value="0" min="0" step="0.1" />
        </div>
        <div class="button-container" id="buttonContainer">
          <button id="exportVideoButton" class="action-button primary" disabled>Exportar WebM</button>
          <button id="exportGifButton" class="action-button secondary" disabled>Exportar GIF</button>
          <button id="exportMp4Button" class="action-button primary" disabled>Exportar MP4</button>
        </div>
        <div class="button-container full-width">
            <button id="resetButton" class="action-button tertiary" disabled>Limpiar</button>
        </div>
      </aside>
    </div>
  </main>
  
  <div id="toast-notification"></div>

  <footer class="app-footer">
    <p>© <span id="currentYear"></span> Animador de Imágenes Pro+. Mejorado por Gemini.</p>
  </footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Element Selection ---
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const animatedOutputContainer = document.getElementById('animatedOutputContainer');
    const placeholderText = animatedOutputContainer.querySelector('.placeholder-text');
    const dropZone = document.getElementById('drop-zone');
    const dragOverlay = dropZone.querySelector('.drag-overlay');
    const toast = document.getElementById('toast-notification');

    const animationControls = {
        type: document.getElementById('animationType'),
        direction: document.getElementById('animationDirection'),
        duration: document.getElementById('animationDuration'),
        iteration: document.getElementById('animationIteration'),
        delay: document.getElementById('animationDelay')
    };
    
    const exportVideoButton = document.getElementById('exportVideoButton');
    const exportGifButton = document.getElementById('exportGifButton');
    const exportMp4Button = document.getElementById('exportMp4Button');
    const resetButton = document.getElementById('resetButton');

    // --- State Variables ---
    let currentImageSrc = null;
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;

    // --- UI & Toast Notifications ---
    function showToast(message, duration = 3000) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, duration);
    }
    
    function updateButtonStates() {
        const hasImage = !!currentImageSrc;
        const isInfinite = parseInt(animationControls.iteration.value, 10) === 0;
        
        resetButton.disabled = !hasImage;
        exportVideoButton.disabled = !hasImage || isInfinite || isRecording;
        exportGifButton.disabled = !hasImage || isInfinite || isRecording;
        exportMp4Button.disabled = !hasImage || isInfinite || isRecording;
    }

    // --- File Handling (Upload & Drag-Drop) ---
    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) {
            showToast('Por favor, selecciona un archivo de imagen válido.');
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImageSrc = e.target.result;
            imagePreview.src = currentImageSrc;
            imagePreview.style.display = 'block';
            if (placeholderText) placeholderText.style.display = 'none';
            updateButtonStates();
            applyAnimation();
            showToast('¡Imagen cargada!');
        };
        reader.readAsDataURL(file);
    }

    // --- Core Animation Logic ---
    function applyAnimation() {
        if (!currentImageSrc) return;

        const animationType = animationControls.type.value;
        const direction = animationControls.direction.value;
        const duration = parseFloat(animationControls.duration.value) || 1;
        const iterationCount = parseInt(animationControls.iteration.value, 10);
        const delay = parseFloat(animationControls.delay.value) || 0;

        // Force reflow to restart animation
        imagePreview.style.animation = 'none';
        void imagePreview.offsetWidth;

        imagePreview.className = 'animated-image';
        if (animationType) {
            imagePreview.classList.add(`animate-${animationType}`);
        }

        imagePreview.style.animationDirection = direction;
        imagePreview.style.animationDuration = `${duration}s`;
        imagePreview.style.animationIterationCount = iterationCount === 0 ? 'infinite' : `${iterationCount}`;
        imagePreview.style.animationDelay = `${delay}s`;
        
        updateButtonStates();
    }
    
    // --- Reset Logic ---
    function resetApplication() {
        currentImageSrc = null;
        imagePreview.src = '#';
        imagePreview.style.display = 'none';
        imagePreview.style.animation = '';
        imagePreview.className = '';
        if (placeholderText) placeholderText.style.display = 'block';
        imageUpload.value = '';

        animationControls.type.value = '';
        animationControls.direction.value = 'normal';
        animationControls.duration.value = 1;
        animationControls.iteration.value = 1;
        animationControls.delay.value = 0;
        
        updateButtonStates();
        showToast('Lienzo limpiado.');
    }

    // --- Exporting Logic (Video & GIF) ---
    function startVideoRecording() {
        if (typeof MediaRecorder === 'undefined') {
            return showToast('Tu navegador no soporta la grabación de video.');
        }

        const duration = (parseFloat(animationControls.duration.value) || 1) * (parseInt(animationControls.iteration.value, 10) || 1);
        const totalDurationMs = (duration + (parseFloat(animationControls.delay.value) || 0)) * 1000;
        
        isRecording = true;
        updateButtonStates();
        const originalButtonText = exportVideoButton.innerHTML;
        exportVideoButton.innerHTML = '<span class="recording-dot"></span>Grabando...';
        
        const stream = animatedOutputContainer.captureStream(30); // 30 fps
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
        recordedChunks = [];

        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'animacion.webm';
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);

            isRecording = false;
            exportVideoButton.innerHTML = originalButtonText;
            updateButtonStates();
        };

        mediaRecorder.start();
        setTimeout(() => {
            if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        }, totalDurationMs + 200); // Buffer
    }

    async function startMp4Recording() {
        if (typeof MediaRecorder === 'undefined' ||
            typeof window.createFFmpeg === 'undefined' ||
            typeof window.fetchFile === 'undefined') {
            return showToast('Tu navegador no soporta la exportación a MP4.');
        }

        const duration = (parseFloat(animationControls.duration.value) || 1) * (parseInt(animationControls.iteration.value, 10) || 1);
        const totalDurationMs = (duration + (parseFloat(animationControls.delay.value) || 0)) * 1000;

        isRecording = true;
        updateButtonStates();
        const originalButtonText = exportMp4Button.innerHTML;
        exportMp4Button.innerHTML = '<span class="recording-dot"></span>Procesando...';

        const stream = animatedOutputContainer.captureStream(30);
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
        recordedChunks = [];

        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const webmBlob = new Blob(recordedChunks, { type: 'video/webm' });
            const { createFFmpeg, fetchFile } = window;
            const ffmpeg = createFFmpeg({ log: false });
            await ffmpeg.load();
            ffmpeg.FS('writeFile', 'input.webm', await fetchFile(webmBlob));
            await ffmpeg.run('-i', 'input.webm', '-c:v', 'libx264', '-preset', 'veryfast', '-pix_fmt', 'yuv420p', 'output.mp4');
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(mp4Blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'animacion.mp4';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
            isRecording = false;
            exportMp4Button.innerHTML = originalButtonText;
            updateButtonStates();
        };

        mediaRecorder.start();
        setTimeout(() => {
            if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        }, totalDurationMs + 200);
    }

    function startGifRecording() {
        isRecording = true;
        updateButtonStates();
        const originalButtonText = exportGifButton.innerHTML;
        exportGifButton.innerHTML = '<span class="recording-dot"></span>Generando...';

        const totalDuration = (parseFloat(animationControls.duration.value) || 1) * (parseInt(animationControls.iteration.value, 10) || 1);
        const totalDelay = parseFloat(animationControls.delay.value) || 0;

        const gif = new GIF({
            workers: 2,
            quality: 10,
            width: animatedOutputContainer.offsetWidth,
            height: animatedOutputContainer.offsetHeight,
            workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
        });

        // We need a canvas to draw each frame
        const canvas = document.createElement('canvas');
        canvas.width = animatedOutputContainer.offsetWidth;
        canvas.height = animatedOutputContainer.offsetHeight;
        const ctx = canvas.getContext('2d');

        const frameRate = 20; // 20 fps
        const frameDelay = 1000 / frameRate;
        const totalFrames = Math.ceil((totalDuration + totalDelay) * frameRate);
        let currentFrame = 0;

        // Reset and play animation from the start
        applyAnimation(); 

        function captureFrame() {
            if (currentFrame >= totalFrames) {
                gif.render();
                return;
            }

            // Clear canvas and draw the current state of the image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff'; // Match background
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const style = window.getComputedStyle(imagePreview);
            const matrix = new DOMMatrix(style.transform);
            const { width, height } = imagePreview.getBoundingClientRect();

            ctx.save();
            // Apply CSS transform to the canvas context
            ctx.translate(matrix.e, matrix.f);
            ctx.drawImage(imagePreview, 0, 0, width, height);
            ctx.restore();

            gif.addFrame(ctx, {copy: true, delay: frameDelay});
            currentFrame++;
            setTimeout(captureFrame, frameDelay);
        }
        
        setTimeout(captureFrame, totalDelay * 1000); // Start capturing after the animation delay

        gif.on('finished', (blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'animacion.gif';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            isRecording = false;
            exportGifButton.innerHTML = originalButtonText;
            updateButtonStates();
        });
    }

    // --- Event Listeners ---
    imageUpload.addEventListener('change', (event) => handleFile(event.target.files[0]));

    dropZone.addEventListener('dragover', (event) => {
        event.preventDefault();
        dragOverlay.classList.add('visible');
    });
    dropZone.addEventListener('dragleave', () => dragOverlay.classList.remove('visible'));
    dropZone.addEventListener('drop', (event) => {
        event.preventDefault();
        dragOverlay.classList.remove('visible');
        handleFile(event.dataTransfer.files[0]);
    });

    Object.values(animationControls).forEach(control => {
        control.addEventListener('input', applyAnimation);
    });

    exportVideoButton.addEventListener('click', startVideoRecording);
    exportGifButton.addEventListener('click', startGifRecording);
    exportMp4Button.addEventListener('click', startMp4Recording);
    resetButton.addEventListener('click', resetApplication);

    // --- Initialization ---
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    updateButtonStates();
});
</script>

</body>
</html>
